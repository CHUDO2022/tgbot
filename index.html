<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale_iPhone</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <header>
            <button class="close-btn">Close</button>
            <span class="app-name">Sale_iPhone</span>
            <div id="user-info" class="user-info"></div>
        </header>
        <div class="search-bar">
            <input type="text" placeholder="Найти кроссовки">
        </div>
        <div class="navigation">
            <button id="home-btn">Главная</button>
            <button id="stats-btn" style="display: none;">Статистика</button>
        </div>
        <div id="main-content">
            <div class="cards-container">
                <button class="card" id="card1">Зови друзей! +500Р</button>
                <button class="card" id="card2">Знакомьтесь, Poizon!</button>
                <button class="card" id="card3">Что умеет Unicorn?</button>
                <button class="card" id="card4">3 способа заказать кроссовки</button>
            </div>
            <div class="container">
                <div class="items-wrapper">
                    <div class="item">
                        <img src="https://opis-cdn.tinkoffjournal.ru/mercury/best-iphones-short-1.nuuqgo7p7bnz..png" alt="Product 1" class="img">
                        <button class="btn" id="btn1">Add</button>
                    </div>
                    <div class="item">
                        <img src="https://opis-cdn.tinkoffjournal.ru/mercury/best-iphones-2.g82vmp0ybhyv..jpg" alt="Product 2" class="img">
                        <button class="btn" id="btn2">Add</button>
                    </div>
                    <div class="item">
                        <img src="https://www.apple.com/v/ipad/home/ck/images/overview/welcome/welcome_hero_startframe__t2k4bw3ehv2a_xlarge.jpg" alt="Product 3" class="img">
                        <button class="btn" id="btn3">Add</button>
                    </div>
                    <div class="item">
                        <img src="https://opis-cdn.tinkoffjournal.ru/mercury/best-iphones-short-1.nuuqgo7p7bnz..png" alt="Product 4" class="img">
                        <button class="btn" id="btn4">Add</button>
                    </div>
                    <div class="item">
                        <img src="https://store-apple.msk.ru/image/cache/catalog/tovary/macbook/air-m2-2022/apple-macbook-air-m2-midnight-2022-800x800.jpg" alt="Product 5" class="img">
                        <button class="btn" id="btn5">Add</button>
                    </div>
                    <div class="item">
                        <img src="https://www.apple.com/v/ipad/home/ck/images/overview/welcome/welcome_hero_startframe__t2k4bw3ehv2a_xlarge.jpg" alt="Product 6" class="img">
                        <button class="btn" id="btn6">Add</button>
                    </div>
                </div>
            </div>
            <div id="usercard" class="usercard"></div>
        </div>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.btn');
            const userCard = document.getElementById('usercard');
            const telegram = window.Telegram.WebApp;
            const userInfo = document.getElementById('user-info');
            const homeBtn = document.getElementById('home-btn');
            const mainContent = document.getElementById('main-content');
            const statsBtn = document.getElementById('stats-btn');

            homeBtn.addEventListener('click', () => {
                mainContent.classList.remove('hidden');
            });

            statsBtn.addEventListener('click', () => {
                fetch('https://57e9-178-129-118-231.ngrok-free.app/get-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        alert("Log file sent to Telegram successfully");
                    } else {
                        alert("Error sending log file: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при получении файла:', error);
                });
            });

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const productId = button.id.replace('btn', ''); // Извлекаем номер товара из id кнопки
                    const message = `Вы выбрали такой товар №${productId}`;
                    userCard.textContent = message;

                    // Отправляем данные на сервер
                    const data = { productId: productId, message: message, query_id: telegram.initDataUnsafe.query_id };
                    fetch('https://57e9-178-129-118-231.ngrok-free.app/webapp-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Ответ от сервера:', data);
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });

                    // Для отладки выводим данные в консоль
                    console.log('Отправленные данные:', data);
                });
            });

            const closeBtn = document.querySelector('.close-btn');
            closeBtn.addEventListener('click', () => {
                telegram.close();
            });

            // Получаем данные о пользователе из Telegram Web Apps API
            const initDataUnsafe = telegram.initDataUnsafe;
            console.log('initDataUnsafe:', initDataUnsafe);  // Отладочный вывод
            
            const user = initDataUnsafe.user;

            if (user) {
                console.log('Данные пользователя:', user); // Отладочный вывод

                let profName = document.createElement('p'); //создаем параграф
                profName.innerText = `${user.first_name} ${user.last_name || ''} (${user.username || ''}) [${user.language_code || ''}]`;
                userCard.appendChild(profName); //добавляем 

                let userid = document.createElement('p'); //создаем еще параграф 
                userid.innerText = `ID: ${user.id}`; //показываем user_id
                userCard.appendChild(userid); //добавляем

                userInfo.innerHTML = `
                    <img src="https://cdn-icons-png.flaticon.com/512/149/149452.png" alt="User Icon">
                    <span>
                        <span class="username">${user.first_name}</span>
                        <span class="status">Новичок</span>
                    </span>
                `;

                // Проверка наличия пользователя в списке разрешенных для кнопки "Статистика"
                const allowedUsers = [698266175, 6039728055, 408985787]; // Здесь укажите ID пользователей, которым доступна кнопка
                if (allowedUsers.includes(user.id)) {
                    statsBtn.style.display = 'block'; // Показываем кнопку "Статистика"
                } else {
                    statsBtn.style.display = 'none'; // Скрываем кнопку "Статистика"
                }

                // Отправляем данные пользователя на сервер
                const userData = {
                    action: 'get_user_data',
                    user_id: user.id,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    username: user.username,
                    phone_number: initDataUnsafe.user.phone_number || '',  // Проверка наличия номера телефона
                    query_id: telegram.initDataUnsafe.query_id
                };
                fetch('https://57e9-178-129-118-231.ngrok-free.app/user-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Ответ от сервера:', data);
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });

                console.log('Отправленные данные пользователя:', userData); // Отладочный вывод
            } else {
                console.log('Нет данных пользователя'); // Отладочный вывод
            }

            // Получаем данные из Telegram бота
            telegram.onEvent('web_app_data', function(data) {
                const profileData = JSON.parse(data);
                console.log('Получены данные профиля:', profileData); // Отладочный вывод
                userInfo.innerHTML = `
                    <img src="https://cdn-icons-png.flaticon.com/512/149/149452.png" alt="User Icon">
                    <span>
                        <span class="username">${profileData.first_name}</span>
                        <span class="status">Новичок</span>
                    </span>
                `;
            });
        });
    </script>
</body>
</html>
